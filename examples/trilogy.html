<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aetheria – Sequence (Mermaid)</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #11182d;
      --text: #e6e8ef;
      --muted: #93a1c1;
      --accent: #7aa2f7;
      --btn: #1b2340;
      --btn-hover: #243059;
      --ok: #3ecf8e;
      --warn: #f4bf75;
    }
    [data-theme="light"] {
      --bg: #f7f8fc;
      --panel: #ffffff;
      --text: #0b1020;
      --muted: #4b5563;
      --accent: #1d4ed8;
      --btn: #e5e7eb;
      --btn-hover: #d1d5db;
      --ok: #059669;
      --warn: #b45309;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 12px;
    }
    header, footer {
      padding: 12px 16px;
      background: var(--panel);
      box-shadow: 0 1px 0 rgba(255,255,255,0.04) inset;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: 0.2px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 8px; }
    button, select {
      background: var(--btn);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: var(--btn-hover); }
    button.primary { border-color: var(--accent); }
    button.ok { border-color: var(--ok); }
    button.warn { border-color: var(--warn); }
    .layout { display: grid; grid-template-columns: 380px 1fr; gap: 12px; padding: 0 12px 12px; }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel h2 { margin: 12px; font-size: 14px; font-weight: 600; color: var(--muted); }
    textarea {
      width: 100%;
      flex: 1;
      resize: none;
      background: transparent;
      color: var(--text);
      border: 0; outline: none;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px; line-height: 1.4; tab-size: 2; white-space: pre;
    }
    .diagram-wrap { position: relative; overflow: auto; flex: 1; }
    .diagram-inner { padding: 12px; min-height: 100%; }
    .hint { margin: 8px 12px 12px; color: var(--muted); font-size: 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; padding: 12px; border-top: 1px solid rgba(255,255,255,0.06); }
    .grow { flex: 1; }
    .kbd { padding: 1px 6px; border: 1px solid rgba(255,255,255,0.15); border-bottom-width: 2px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: var(--muted); }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(122,162,247,0.15); border: 1px solid rgba(122,162,247,0.45); color: var(--accent); font-size: 12px; margin-left: 8px; }
    footer { font-size: 12px; color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body data-theme="dark">
  <header>
    <h1>Aetheria – Mermaid Sequence<span class="badge">static&nbsp;HTML</span></h1>
    <div class="toolbar">
      <button id="btn-render" class="primary">Render (⌘/Ctrl+Enter)</button>
      <button id="btn-copy">Copy Mermaid</button>
      <button id="btn-download-svg" class="ok">Download SVG</button>
      <button id="btn-download-png" class="ok">Download PNG</button>
      <select id="theme">
        <option value="dark" selected>Dark</option>
        <option value="neutral">Neutral</option>
        <option value="forest">Forest</option>
        <option value="base">Base</option>
        <option value="light">Light (UI)</option>
      </select>
      <span class="grow"></span>
      <button id="btn-fit">Fit to Width</button>
      <button id="btn-reset">Original Size</button>
      <button id="btn-toggle-ui">UI Theme: Dark</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel">
      <h2>Mermaid Source</h2>
      <textarea id="source" spellcheck="false">sequenceDiagram
    %% --- Figuren ---
    participant Kaelen as "Kaelen Veyra (Flammendes Herz)"
    participant Sylra as "Sylra D’Tharn (Schatten der Seele)"
    participant Morvath as "Lord Morvath (Ungeheuer des Griefs)"
    participant Elyra as "Elyra – Die Vergessene (die fließende Erinnerung)"
    participant Celestine as "Celestine – Helle Welt"
    participant Nyxara as "Nyxara – Dunkle Welt"
    participant Veyra as "Veyra – Tal der Gesichter"
    participant ThalVor as "Thal’Vor – Land der Sprachlosen"
    participant Vale as "The Vale of Whispers – Tal der Geflüsterten Namen"
    participant Aetheria as "Aetheria – die Welt"

    %% --- Prolog / Exposition ---
    rect rgba(255,255,200,0.25)
      Note over Kaelen,Celestine: Kaelen stammt aus Celestine – verbannt, da er die Flamme der Liebe als unheilig sah.
      Note over Sylra,Nyxara: Sylra aus Nyxara – floh, als sie ihre Emotionen nicht mehr kontrollieren konnte.
      Note over Morvath,Nyxara: Morvath war General in Nyxara – verlor seine Familie durch Verrat.
    end

    %% --- Fluchten & Aufstieg Morvaths (Parallel) ---
    par Fluchten
      Kaelen ->> Celestine: Flieht nach dem Tod seiner Geliebten Lirien
      Kaelen ->> Veyra: Erreicht das Tal der Gesichter – 30 verlorene Masken
      Sylra ->> Nyxara: Flüchtet nach dem Tod ihres Meisters
      Sylra ->> ThalVor: Lernt, dass Schmerz nicht immer Macht ist
    and Morvaths Aufstieg
      Morvath ->> Nyxara: Stürzt den Thron – wird zum „Hollow King“
      Morvath ->> Celestine: Stürmt die Stadt – will die „Herz-Reliquie“
      Morvath ->> Nyxara: Zerstört das Denkmal – „Der König der Liebe ist tot. Es bleibt nur Grief.“
      Note over Morvath: Er glaubt, Liebe sei der Grund allen Leidens.
    end

    %% --- Erste Koinzidenz ---
    Note over Kaelen,Sylra: Beide von Morvath gejagt – „Die Liebenden von Feuer und Schatten werden die Welt entzünden.“

    %% --- Erscheinungen Elyras (Aktivierung) ---
    activate Elyra
    Elyra ->> Veyra: „Schlange aus Licht“ – *„Die Flamme tanzt beim Lachen, nicht bei Angst.“*
    Elyra ->> ThalVor: Zeigt Sylra ein Bild ihrer lebenden Mutter – *„Liebe ist Atempause, kein Werkzeug.“*
    deactivate Elyra

    %% --- Treffen im Vale ---
    Kaelen ->> Vale: Flüstert „Lirien“ – sie erscheint als Schatten
    Sylra ->> Vale: Flüstert „Mutter“ – die Stimme antwortet, doch ist nicht ihre Mutter
    Note over Kaelen,Sylra: Erstes Treffen – Hände berühren, die Luft zittert.
    Kaelen -->> Sylra: *„Ich sah dich in einem endlosen Traum.“*
    Sylra -->> Kaelen: *„Du warst kein Traum. Du warst mein Gedächtnis.“*

    %% --- Suche nach Sinn (opt = Frage) ---
    opt Sinnfrage
      Kaelen -->> Elyra: Warum leiden, wenn sie lieben?
      Sylra -->> Elyra: Warum leiden, wenn sie lieben?
    end

    %% --- Rückblenden / Enthüllungen (Parallelreise) ---
    activate Elyra
    par Elyra durch Celestine/Nyxara
      Elyra ->> Celestine: Sieht Kaelen als Kind – wirft eine Flamme gen Himmel
    and
      Elyra ->> Nyxara: Sieht Morvath als Jungen – umarmt seine Schwester
    end
    Elyra ->> Kaelen: *„Nicht verloren, weil du liebst – sondern weil du Liebe für einen Fehler hältst.“*
    Elyra ->> Sylra: *„Nicht verletzt durch Liebe – sondern weil du sie als Waffe glaubst.“*
    deactivate Elyra

    %% --- Ewiges Theater: Konfrontation ---
    rect rgba(255,220,220,0.25)
      Kaelen -->> Morvath: Treffen im Ewigen Theater – Schlacht der Gefühle
      Sylra -->> Morvath: Treffen im Ewigen Theater – Schlacht der Gefühle
      Morvath ->> Kaelen: *„Ich will Liebe zerstören – sie verletzt mich.“*
      Morvath ->> Sylra: *„Deine Mutter liebte mich – und verließ mich.“*
    end

    %% --- Elyras Nadelstich (kurze Aktivierung) ---
    activate Elyra
    Elyra ->> Morvath: Erste Lacher – *„Dann liebte sie dich, als du noch lachen konntest.“*
    deactivate Elyra
    Morvath ->> Elyra: Zittert. Weint.
    Note over Morvath: Für einen Herzschlag sieht er Licht, das nicht brennt.

    %% --- Verbund aus Flamme & Schatten (Parallelangriff) ---
    par Verbund
      Kaelen -->> Morvath: Hände verbinden Flamme mit Schatten
      Sylra -->> Morvath: Hände verbinden Flamme mit Schatten
    end
    Kaelen ->> Morvath: *„Liebe ist kein Fehler – sie hält uns am Leben.“*
    Sylra ->> Morvath: *„Ich machte Liebe zur Waffe – dich liebe ich, ohne zu töten.“*

    %% --- Elyras Transitus (Broadcast als parallele Botschaft) ---
    activate Elyra
    par Durch die Reiche
      Elyra ->> Celestine: Körper zerfällt in Licht
    and
      Elyra ->> Nyxara: Körper zerfällt in Schatten
    end
    par Letzte Worte
      Elyra ->> Kaelen: *„Ihr wart nur vergessen.“*
      Elyra ->> Sylra: *„Ihr wart nur vergessen.“*
      Elyra ->> Morvath: *„Ihr wart nur vergessen.“*
      Elyra ->> Celestine: *„Ihr wart nur vergessen.“*
      Elyra ->> Nyxara: *„Ihr wart nur vergessen.“*
      Elyra ->> Veyra: *„Ihr wart nur vergessen.“*
      Elyra ->> ThalVor: *„Ihr wart nur vergessen.“*
      Elyra ->> Vale: *„Ihr wart nur vergessen.“*
    end
    deactivate Elyra

    %% --- Epilog ---
    Note over Aetheria: Die Welt atmet neu.
    Kaelen -->> Elyra: Sie sehen sie nicht – doch spüren ihr Gehen.
    Sylra -->> Elyra: Stille Gegenwart in Abwesenheit.
    Kaelen ->> Sylra: *„Sie war nicht hier, um zu helfen.“*
    Sylra ->> Kaelen: *„Nein. Sie war hier, um zu erinnern.“*
    Note over Aetheria: Die Welt beginnt wieder zu träumen.</textarea>
      <div class="row">
        <span class="hint">Tipp: <span class="kbd">⌘/Ctrl</span> + <span class="kbd">Enter</span> rendert neu.</span>
      </div>
    </section>

    <section class="panel diagram">
      <h2>Diagram</h2>
      <div class="diagram-wrap">
        <div class="diagram-inner" id="diagram"></div>
      </div>
      <div class="row">
        <span class="hint">Scroll/Zoom via Browser (⌘/Ctrl + Mausrad). „Fit to Width“ setzt <code>width:100%</code> auf die SVG.</span>
      </div>
    </section>
  </main>

  <footer>
    Mermaid läuft lokal im Browser über CDN. Für Offline-Nutzung ersetzen Sie die Script-URLs durch lokale Dateien.
  </footer>

  <!-- Mermaid via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    // App state
    const uiState = { mermaidTheme: 'dark', uiTheme: 'dark', fitted: false, lastSvg: null };

    function initMermaid(theme) {
      mermaid.initialize({
        startOnLoad: false,
        theme: theme === 'base' ? 'base' : (['dark','neutral','forest'].includes(theme) ? theme : 'neutral'),
        securityLevel: 'loose',
        fontFamily: 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, Liberation Sans, sans-serif',
        sequence: { mirrorActors: false, rightAngles: false, showSequenceNumbers: false, useMaxWidth: true }
      });
    }
    function currentSvgEl() { return document.querySelector('#diagram svg'); }
    async function renderDiagram() {
      const src = document.getElementById('source').value;
      const { svg } = await mermaid.render('aetheria_seq', src);
      const host = document.getElementById('diagram');
      host.innerHTML = svg;
      uiState.lastSvg = svg;
      if (uiState.fitted) fitToWidth();
    }
    function fitToWidth() {
      const svg = currentSvgEl(); if (!svg) return;
      svg.style.width = '100%'; svg.removeAttribute('height'); uiState.fitted = true;
    }
    function resetSize() {
      const svg = currentSvgEl(); if (!svg) return;
      svg.style.width = '';
      if (!svg.getAttribute('height')) {
        const vb = svg.getAttribute('viewBox'); if (vb) {
          const p = vb.split(' ').map(parseFloat);
          if (p.length === 4) { const h = p[3] || 800; svg.setAttribute('height', String(Math.round(h))); }
        }
      }
      uiState.fitted = false;
    }
    function copySource() {
      const src = document.getElementById('source').value;
      navigator.clipboard.writeText(src).then(() => { flash('Mermaid-Code kopiert.'); });
    }
    function flash(msg) {
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position = 'fixed'; el.style.bottom = '16px'; el.style.right = '16px';
      el.style.background = 'rgba(0,0,0,0.75)'; el.style.color = 'white';
      el.style.padding = '10px 12px'; el.style.borderRadius = '10px'; el.style.zIndex = '9999';
      document.body.appendChild(el); setTimeout(() => el.remove(), 1600);
    }
    function svgString() {
      const svg = currentSvgEl(); if (!svg) return null;
      const clone = svg.cloneNode(true);
      if (!clone.style.background) {
        const bg = getComputedStyle(document.body).getPropertyValue('--panel') || '#ffffff';
        clone.style.background = bg.trim();
      }
      const serializer = new XMLSerializer();
      const raw = serializer.serializeToString(clone);
      return '<?xml version="1.0" encoding="UTF-8"?>\n' + raw;
    }
    function downloadBlob(content, mime, filename) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function downloadSVG() {
      const s = svgString(); if (!s) return;
      downloadBlob(s, 'image/svg+xml;charset=utf-8', 'aetheria-sequence.svg');
    }
    function svgToPng(svgText, scale = 2) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(svgBlob);
        img.onload = () => {
          const w = img.naturalWidth || 1600;
          const h = img.naturalHeight || 900;
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(w * scale); canvas.height = Math.round(h * scale);
          const ctx = canvas.getContext('2d');
          const bg = getComputedStyle(document.body).getPropertyValue('--panel') || '#ffffff';
          ctx.fillStyle = bg.trim(); ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => { URL.revokeObjectURL(url); if (!blob) reject(new Error('PNG encode failed')); else resolve(blob); }, 'image/png');
        };
        img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
        img.src = url;
      });
    }
    async function downloadPNG() {
      const s = svgString(); if (!s) return;
      const blob = await svgToPng(s, 2.5);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'aetheria-sequence.png';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function setUiTheme(mode) {
      document.body.setAttribute('data-theme', mode === 'light' ? 'light' : 'dark');
      document.getElementById('btn-toggle-ui').textContent = `UI Theme: ${mode === 'light' ? 'Light' : 'Dark'}`;
    }
    window.addEventListener('DOMContentLoaded', () => {
      initMermaid('dark'); renderDiagram();
      document.getElementById('btn-render').addEventListener('click', renderDiagram);
      document.getElementById('btn-copy').addEventListener('click', copySource);
      document.getElementById('btn-download-svg').addEventListener('click', downloadSVG);
      document.getElementById('btn-download-png').addEventListener('click', downloadPNG);
      document.getElementById('btn-fit').addEventListener('click', fitToWidth);
      document.getElementById('btn-reset').addEventListener('click', resetSize);
      document.getElementById('theme').addEventListener('change', (e) => {
        const t = e.target.value;
        uiState.mermaidTheme = t;
        initMermaid(t === 'light' ? 'neutral' : t);
        renderDiagram();
      });
      document.getElementById('btn-toggle-ui').addEventListener('click', () => {
        uiState.uiTheme = uiState.uiTheme === 'dark' ? 'light' : 'dark';
        setUiTheme(uiState.uiTheme);
      });
      window.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); renderDiagram(); }
      });
    });
  </script>
</body>
</html>